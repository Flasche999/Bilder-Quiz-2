<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin · Bilder-Rätsel Quiz</title>
  <link rel="stylesheet" href="/style.css"/>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <div class="container">
    <!-- Verlauf / History -->
    <div class="card">
      <h3>Verlauf / History</h3>
      <div class="row" style="align-items:center;justify-content:space-between">
        <div class="tag">Runden-Fortschritt: <span id="roundProgress">–</span></div>
        <div class="small">Auto-Weiter nach Auflösung verfügbar</div>
      </div>
      <div id="historyList" style="max-height:220px;overflow:auto;margin-top:8px"></div>
    </div>

    <!-- Bild-Pool Upload -->
    <div class="card">
      <h3>Bild-Pool Upload</h3>
      <div class="row">
        <input id="fileInput" type="file" multiple accept="image/*"/>
        <button id="btnUpload" class="btn">⬆️ Hochladen</button>
      </div>
      <div id="uploadList" class="small" style="margin-top:8px"></div>
    </div>

    <!-- Wer ist dran? -->
    <div class="card">
      <h3>Wer ist dran?</h3>
      <div class="row" style="align-items:center;gap:8px">
        <div class="tag">Aktuell: <span id="turnNow">–</span></div>
        <select id="turnSelect"></select>
        <button id="btnPrevTurn" class="btn">⬅️ Vorheriges Team</button>
        <button id="btnNextTurn" class="btn">➡️ Nächstes Team</button>
      </div>
      <div class="small">Hinweis: Reihenfolge ist alphabetisch nach Teamnamen. Auswahl wirkt sofort.</div>
    </div>

    <!-- Playlist / Runden -->
    <div class="card">
      <h3>Playlist / Runden</h3>
      <div class="row">
        <div class="col">
          <label>Playlist JSON (Array von Runden)</label>
          <textarea id="playlistJson" rows="6" placeholder='[
  {"imageUrl":"/images/sample.svg","question":"Wo ist die 8?","radius":45,"target":{"x":400,"y":475}},
  {"imageUrl":"/images/sample.svg","question":"Wo ist die 2?","radius":45,"target":{"x":400,"y":125}}
]'></textarea>
        </div>
        <div class="col" style="min-width:280px">
          <label>Steuerung</label>
          <div class="row">
            <button id="btnLoadPlaylist" class="btn">📥 Playlist laden</button>
            <button id="btnStartCurrent" class="btn acc">▶️ Runde starten (aktuell)</button>
            <button id="btnNextRound" class="btn">⏭️ Nächste Runde</button>
          </div>
          <div class="tag">Aktueller Index: <span id="roundIndex">0</span></div>
        </div>
      </div>
    </div>

    <h1>Admin · Bilder-Rätsel Quiz</h1>

    <!-- Hauptkarte: Bild, Frage, Steuerung, Punkte -->
    <div class="card">
      <div class="row">
        <div class="col">
          <label>Bild-URL</label>
          <input id="imageUrl" placeholder="/images/sample.jpg" value="/images/sample.jpg"/>
        </div>
        <div class="col">
          <label>Countdown (Sek.)</label>
          <input id="countdown" type="number" value="15" min="3" max="120"/>
        </div>
        <div class="col">
          <label>Klick-Radius (px)</label>
          <input id="radius" type="number" value="45" min="5" max="200"/>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>Gesuchter Bereich (per Klick setzen) &amp; Live-Overlay</label>
          <div id="board" class="board" style="position:relative">
            <canvas id="overlay" style="position:absolute;inset:0;pointer-events:none"></canvas>
            <img id="img" src="/images/sample.jpg" alt="Preview"/>
            <div id="mask" class="mask" style="display:none"></div>
            <div id="target" class="marker locked" style="display:none;width:90px;height:90px"></div>
          </div>
          <div class="small">Tipp: Klicke in das Bild, um Zielkoordinaten zu setzen. Der Kreis zeigt den Radius.</div>
        </div>
        <div style="min-width:280px" class="col">
          <label>Frage</label>
          <input id="question" placeholder="Frage für die Runde (wird Spielern angezeigt)"/>
          <div class="hr"></div>
          <label>Rundensteuerung</label>
          <div class="row">
            <button id="btnStart" class="btn acc">▶️ Runde starten</button>
            <button id="btnRevealGuesses" class="btn">👀 Klicks zeigen</button>
            <button id="btnRevealArea" class="btn good">🎯 Bereich aufdecken</button>
            <button id="btnRevealAuto" class="btn good">🎯 Auflösen (Auto-Weiter)</button>
            <button id="btnShowFull" class="btn warn">🖼️ Bild komplett zeigen</button>
          </div>
          <div class="hr"></div>
          <label>Teams & Punkte</label>
          <div id="teamLegend" class="small" style="margin:6px 0">Farben: Team A–D = feste Farben</div>
          <div id="teams"></div>
        </div>
      </div>
    </div>

    <!-- Lobby -->
    <div class="card">
      <h3>Lobby / Verbindungen</h3>
      <div id="lobby"></div>
    </div>
  </div>

  <script>
    const socket = io();
    const COLORS = ["#4da3ff","#ff4d6d","#22c55e","#eab308"]; // bis zu 4 Teams
    let playlist = [];
    let roundIdx = 0;
    let adminOverlay = { clicks:{} };

    const imgEl = document.getElementById('img');
    const targetEl = document.getElementById('target');
    const boardEl = document.getElementById('board');
    const maskEl = document.getElementById('mask');
    const imageUrlInput = document.getElementById('imageUrl');
    const countdownInput = document.getElementById('countdown');
    const radiusInput = document.getElementById('radius');
    const teamsEl = document.getElementById('teams');
    const lobbyEl = document.getElementById('lobby');

    let target = {x:0,y:0};
    let radius = parseInt(radiusInput.value,10);

    function boardRect(){
      const r = boardEl.getBoundingClientRect();
      return {left:r.left + window.scrollX, top:r.top + window.scrollY, width:r.width, height:r.height};
    }
    function px(v){ return v+'px'; }
    function placeMarkerAt(el, x, y, r){
      el.style.left = px(x);
      el.style.top = px(y);
      el.style.width = px(r*2);
      el.style.height = px(r*2);
      el.style.display = 'block';
    }

    imgEl.addEventListener('load', ()=>{ targetEl.style.display='none'; });
    radiusInput.addEventListener('input',()=>{
      radius = parseInt(radiusInput.value||'45',10);
      if(targetEl.style.display!=='none'){
        targetEl.style.width = px(radius*2);
        targetEl.style.height = px(radius*2);
      }
    });
    imageUrlInput.addEventListener('change', ()=>{ imgEl.src = imageUrlInput.value || '/images/sample.jpg'; });

    boardEl.addEventListener('click', (e)=>{
      const r = boardRect();
      const x = e.pageX - r.left;
      const y = e.pageY - r.top;
      target = {x, y};
      placeMarkerAt(targetEl, x, y, radius);
    });

    // Admin controls (Rundensteuerung)
    document.getElementById('btnStart').onclick = ()=>{
      const payload = {
        imageUrl: imageUrlInput.value || '/images/sample.jpg',
        duration: Math.max(3, parseInt(countdownInput.value||'15',10)),
        radius: Math.max(5, Math.min(200, parseInt(radiusInput.value||'45',10))),
        target,
        question: (document.getElementById('question').value || '')
      };
      socket.emit('admin:startRound', payload);
    };
    document.getElementById('btnRevealGuesses').onclick = ()=> socket.emit('admin:revealGuesses');
    document.getElementById('btnRevealArea').onclick = ()=> socket.emit('admin:revealArea', {autoNext:false});
    document.getElementById('btnRevealAuto').onclick = ()=> socket.emit('admin:revealArea', {autoNext:true, delayMs:3000});
    document.getElementById('btnShowFull').onclick = ()=> socket.emit('admin:showFull');

    // Teams & Punkte
    function renderTeams(state){
      teamsEl.innerHTML = '';
      const t = state.teams || {};
      Object.values(t).forEach(team=>{
        const row = document.createElement('div');
        row.className='score-row';
        row.innerHTML = `
          <div class="name tag" style="border-color:${COLORS[team.colorIdx||0]}">🏷️ ${team.name}</div>
          <div class="score tag">⭐ ${team.points||0}</div>
          <button class="btn good" data-id="${team.id}" data-a="plus1">+1</button>
          <button class="btn bad" data-id="${team.id}" data-a="minus1">-1</button>
          <input class="setInput" data-id="${team.id}" type="number" placeholder="±Punkte"/>
          <button class="btn" data-id="${team.id}" data-a="apply">Setzen</button>
        `;
        teamsEl.appendChild(row);
      });
      teamsEl.querySelectorAll('button').forEach(btn=>{
        const id = btn.getAttribute('data-id');
        const a = btn.getAttribute('data-a');
        if(a==='plus1') btn.onclick = ()=> socket.emit('admin:adjustPoints', {teamId:id, delta: +1});
        if(a==='minus1') btn.onclick = ()=> socket.emit('admin:adjustPoints', {teamId:id, delta: -1});
        if(a==='apply') btn.onclick = ()=> {
          const inp = btn.parentElement.querySelector('.setInput');
          const val = parseInt(inp.value||'0',10);
          socket.emit('admin:adjustPoints', {teamId:id, delta: val});
          inp.value='';
        };
      });
    }

    // Lobby
    function renderLobby(state){ window.__statePlayers = state.players || {};
      const players = Object.values(state.players||{});
      const byTeam = {};
      players.forEach(p=>{
        if(!byTeam[p.teamId]) byTeam[p.teamId] = [];
        byTeam[p.teamId].push(p);
      });
      lobbyEl.innerHTML = Object.entries(byTeam).map(([teamId, list])=>{
        const t = (state.teams||{})[teamId];
        const tname = t ? t.name : '(Team?)';
        const color = t ? COLORS[t.colorIdx||0] : '#888';
        return `<div class="tag" style="border-color:${color}">👥 ${tname}: ${list.map(p=>p.name).join(', ')}</div>`;
      }).join(' ');
    }

    // Overlay Größen-Anpassung
    const overlay = document.getElementById('overlay');
    function fitOverlay(){
      const r = boardEl.getBoundingClientRect();
      overlay.width = r.width;
      overlay.height = r.height;
    }
    window.addEventListener('resize', fitOverlay);
    new ResizeObserver(fitOverlay).observe(boardEl);

    // Overlay zeichnen (Kreise + Labels)
    function drawOverlay(){
      const ctx = overlay.getContext('2d');
      ctx.clearRect(0,0,overlay.width,overlay.height);
      const teams = window.__stateTeams || {};
      const players = window.__statePlayers || {};
      const teamIds = Object.keys(teams);
      ctx.font = '12px system-ui, Arial';
      ctx.textBaseline = 'top';
      teamIds.forEach((tid, idx)=>{
        const color = COLORS[idx % COLORS.length];
        const teamClicks = adminOverlay.clicks[tid] || {};
        Object.entries(teamClicks).forEach(([pid, {x,y}])=>{
          ctx.beginPath();
          ctx.strokeStyle = color;
          ctx.lineWidth = 2;
          ctx.arc(x, y, radius, 0, Math.PI*2);
          ctx.stroke();
          ctx.beginPath();
          ctx.arc(x,y,3,0,Math.PI*2);
          ctx.fillStyle = color;
          ctx.fill();
          // Label mit Team + Spieler
          const pname = (players[pid] && players[pid].name) ? players[pid].name : pid.slice(0,4);
          const tname = (teams[tid] && teams[tid].name) ? teams[tid].name : tid;
          const label = `${tname} · ${pname}`;
          const padding = 3;
          const tw = ctx.measureText(label).width + padding*2;
          const th = 16;
          const lx = Math.min(Math.max(0, x + radius + 6), overlay.width - tw);
          const ly = Math.min(Math.max(0, y - th/2), overlay.height - th);
          ctx.fillStyle = 'rgba(0,0,0,0.6)';
          ctx.fillRect(lx, ly, tw, th);
          ctx.strokeStyle = color;
          ctx.strokeRect(lx, ly, tw, th);
          ctx.fillStyle = '#e5e7eb';
          ctx.fillText(label, lx + padding, ly + 2);
        });
      });
    }

    // Playlist
    const playlistJsonEl = document.getElementById('playlistJson');
    const questionInput = document.getElementById('question');
    const roundIndexEl = document.getElementById('roundIndex');

    document.getElementById('btnLoadPlaylist').onclick = ()=>{
      try{
        const arr = JSON.parse(playlistJsonEl.value || '[]');
        if(!Array.isArray(arr)) throw new Error('Keine Array-Playlist');
        playlist = arr;
        roundIdx = 0;
        roundIndexEl.textContent = roundIdx;
        if(playlist[0]){
          imageUrlInput.value = playlist[0].imageUrl || imageUrlInput.value;
          countdownInput.value = (playlist[0].duration || countdownInput.value);
          radiusInput.value = (playlist[0].radius || radiusInput.value);
          questionInput.value = (playlist[0].question || '');
          imgEl.src = imageUrlInput.value;
          if(playlist[0].target){
            target = playlist[0].target;
            placeMarkerAt(targetEl, target.x, target.y, parseInt(radiusInput.value,10));
          }
        }
        alert('Playlist geladen: '+playlist.length+' Runden');
        updateRoundProgress();
      }catch(e){
        alert('Fehler beim Laden der Playlist: '+e.message);
      }
    };

    document.getElementById('btnStartCurrent').onclick = ()=>{ 
      updateRoundProgress();
      const payload = {
        imageUrl: imageUrlInput.value || '/images/sample.svg',
        duration: Math.max(3, parseInt(countdownInput.value||'15',10)),
        radius: Math.max(5, Math.min(200, parseInt(radiusInput.value||'45',10))),
        target,
        question: questionInput.value || ''
      };
      socket.emit('admin:startRound', payload);
    };

    document.getElementById('btnNextRound').onclick = ()=>{
      if(!playlist.length){ alert('Bitte zuerst eine Playlist laden.'); return; }
      roundIdx = (roundIdx + 1) % playlist.length;
      roundIndexEl.textContent = roundIdx;
      const r = playlist[roundIdx];
      imageUrlInput.value = r.imageUrl || imageUrlInput.value;
      countdownInput.value = r.duration || countdownInput.value;
      radiusInput.value = r.radius || radiusInput.value;
      questionInput.value = r.question || '';
      imgEl.src = imageUrlInput.value;
      target = r.target || {x:0,y:0};
      if(r.target) placeMarkerAt(targetEl, r.target.x, r.target.y, parseInt(radiusInput.value,10));
      else targetEl.style.display='none';
      updateRoundProgress();
    };

    // Admin State-Spiegel für Overlay
    window.__stateTeams = {};
    window.__statePlayers = {};

    // Turn-Rendering (Admin)
    function renderTurn(state){
      const sel = document.getElementById('turnSelect');
      const now = document.getElementById('turnNow');
      const teams = state.teams || {};
      const ids = Object.values(teams).sort((a,b)=> a.name.localeCompare(b.name));
      sel.innerHTML = ids.map(t=> `<option value="${t.id}">${t.name}</option>`).join('');
      if(state.turnTeamId && teams[state.turnTeamId]){
        sel.value = state.turnTeamId;
        now.textContent = teams[state.turnTeamId].name;
        now.style.color = COLORS[teams[state.turnTeamId].colorIdx || 0];
      }else{
        now.textContent = '–';
        now.style.color = '';
      }
    }
    document.getElementById('btnPrevTurn').onclick = ()=> socket.emit('admin:prevTurn');
    document.getElementById('btnNextTurn').onclick = ()=> socket.emit('admin:nextTurn');
    document.getElementById('turnSelect').onchange = (e)=> socket.emit('admin:setTurn', {teamId:e.target.value});
    socket.on('turn:update', ({teamId})=>{
      const teams = window.__stateTeams || {};
      const now = document.getElementById('turnNow');
      if(teams[teamId]){
        now.textContent = teams[teamId].name;
        now.style.color = COLORS[teams[teamId].colorIdx || 0];
        const sel = document.getElementById('turnSelect');
        sel.value = teamId;
      }
    });

    // Global State-Updates
    socket.on('state', s=>{
      window.__stateTeams = s.teams || {};
      renderTeams(s);
      renderLobby(s);
      renderTurn(s);
      fitOverlay();
      drawOverlay();
    });

    // Live-Clicks fürs Admin-Overlay
    socket.on('admin:liveClick', ({teamId, playerId, x, y})=>{
      adminOverlay.clicks[teamId] = adminOverlay.clicks[teamId] || {};
      adminOverlay.clicks[teamId][playerId] = {x,y};
      drawOverlay();
    });

    // Runden-Reset fürs Overlay
    socket.on('round:config', ()=>{
      adminOverlay.clicks = {};
      drawOverlay();
    });

    // History empfangen
    function renderHistory(list){
      const el = document.getElementById('historyList');
      if(!Array.isArray(list) || !list.length){ el.innerHTML = '<div class="small">Noch keine Runden.</div>'; return; }
      el.innerHTML = list.slice().reverse().map((h,idx)=>{
        const date = new Date(h.ts).toLocaleTimeString();
        const winners = (h.winners||[]).map(tid=> (window.__stateTeams[tid]?.name||tid)).join(', ') || '—';
        return `<div class="tag" style="display:block;margin:4px 0">
          <div><strong>${date}</strong> – ${h.question||'(ohne Frage)'} – Gewinner: ${winners}</div>
          <div class="small">${h.imageUrl}</div>
        </div>`;
      }).join('');
    }
    socket.on('admin:history', renderHistory);

    // Fortschritt
    function updateRoundProgress(){
      const total = playlist.length || '–';
      const cur = (playlist.length ? (roundIdx+1) : '–');
      document.getElementById('roundProgress').textContent = `${cur}/${total}`;
      document.getElementById('roundIndex').textContent = (playlist.length ? roundIdx : 0);
    }

    // Auto-Weiter-Request vom Server
    socket.on('admin:requestNext', ()=>{
      if(playlist.length){
        document.getElementById('btnNextRound').click();
        document.getElementById('btnStartCurrent').click();
      }
    });

    // Upload
    async function readFilesAsDataUrls(files){
      const arr = [];
      for(const f of files){
        const dataUrl = await new Promise(res=>{
          const r = new FileReader();
          r.onload = ()=> res(r.result);
          r.readAsDataURL(f);
        });
        arr.push({name:f.name, dataUrl});
      }
      return arr;
    }
    document.getElementById('btnUpload').onclick = async ()=>{
      const inp = document.getElementById('fileInput');
      if(!inp.files.length) return alert('Bitte Dateien wählen.');
      const files = await readFilesAsDataUrls(inp.files);
      const resp = await fetch('/admin/upload', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({files})});
      const data = await resp.json();
      if(!data.ok){ alert('Upload fehlgeschlagen: '+(data.error||'unknown')); return; }
      const list = document.getElementById('uploadList');
      list.innerHTML = data.urls.map(u=> `<a href="${u}" target="_blank">${u}</a> • <button class="btn" data-url="${u}">als Bild wählen</button>`).join('<br>');
      list.querySelectorAll('button').forEach(b=>{
        b.onclick = ()=>{
          const u = b.getAttribute('data-url');
          imageUrlInput.value = u;
          imgEl.src = u;
          alert('Bild gesetzt: '+u);
        };
      });
    };

    // Admin-Handshake
    socket.emit('admin:hello');
  </script>
</body>
</html>

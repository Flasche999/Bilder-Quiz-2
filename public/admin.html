<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin ¬∑ Bilder-R√§tsel Quiz</title>
  <link rel="stylesheet" href="/style.css"/>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    /* Kleine Badges f√ºr Status */
    .badge{display:inline-block;padding:2px 6px;border-radius:8px;font-size:12px;margin-left:6px;border:1px solid rgba(255,255,255,.15);}
    .badge.ok{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.35);color:#a7f3d0;}
    .badge.warn{background:rgba(234,179,8,.12);border-color:rgba(234,179,8,.35);color:#fde68a;}
    .badge.muted{background:rgba(148,163,184,.12);border-color:rgba(148,163,184,.35);color:#cbd5e1;}
    .score-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0;}
    .tag{border:1px solid rgba(255,255,255,.1);padding:4px 8px;border-radius:8px;display:inline-flex;align-items:center;gap:6px}
    .btn{padding:6px 10px;border:1px solid rgba(255,255,255,.15);background:#111827;color:#e5e7eb;border-radius:10px;cursor:pointer}
    .btn.acc{background:#0b3b2f}
    .btn.good{background:#12391f}
    .btn.warn{background:#3a2d0b}
    .btn.bad{background:#3a1212}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:10px 0}
    .board img{max-width:100%;display:block;border-radius:12px}
    .marker{position:absolute;border:2px dashed #eab308;border-radius:999px;pointer-events:none;mix-blend-mode:screen}
    .marker.locked{border-style:solid}
    .container{max-width:1100px;margin:18px auto;padding:0 12px}
    .card{background:#0b0f19;border:1px solid rgba(255,255,255,.07);border-radius:14px;padding:14px;margin:10px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1 1 320px}
    .small{opacity:.8;font-size:13px}
    label{display:block;margin-bottom:6px;opacity:.9}
    input[type="text"], input[type="number"], textarea{
      width:100%;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0b1120;color:#e5e7eb
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Verlauf / History -->
    <div class="card">
      <h3>Verlauf / History</h3>
      <div class="row" style="align-items:center;justify-content:space-between">
        <div class="tag">Runden-Fortschritt: <span id="roundProgress">‚Äì</span></div>
        <div class="small">Auto-Weiter nach Aufl√∂sung verf√ºgbar</div>
      </div>
      <div id="historyList" style="max-height:220px;overflow:auto;margin-top:8px"></div>
    </div>

    <!-- Bild-Pool Upload -->
    <div class="card">
      <h3>Bild-Pool Upload</h3>
      <div class="row">
        <input id="fileInput" type="file" multiple accept="image/*"/>
        <button id="btnUpload" class="btn">‚¨ÜÔ∏è Hochladen</button>
      </div>
      <div id="uploadList" class="small" style="margin-top:8px"></div>
    </div>

    <!-- Wer ist dran? -->
    <div class="card">
      <h3>Wer ist dran?</h3>
      <div class="row" style="align-items:center;gap:8px">
        <div class="tag">Aktuell: <span id="turnNow">‚Äì</span></div>
        <select id="turnSelect"></select>
        <button id="btnPrevTurn" class="btn">‚¨ÖÔ∏è Vorheriges Team</button>
        <button id="btnNextTurn" class="btn">‚û°Ô∏è N√§chstes Team</button>
      </div>
      <div class="small">Hinweis: Reihenfolge ist alphabetisch nach Teamnamen. Auswahl wirkt sofort.</div>
    </div>

    <!-- Playlist / Runden -->
    <div class="card">
      <h3>Playlist / Runden</h3>
      <div class="row">
        <div class="col">
          <label>Playlist JSON (Array von Runden)</label>
          <textarea id="playlistJson" rows="6" placeholder='[
  {"imageUrl":"/images/sample.svg","question":"Wo ist die 8?","radius":45,"target":{"x":400,"y":475}},
  {"imageUrl":"/images/sample.svg","question":"Wo ist die 2?","radius":45,"target":{"x":400,"y":125}}
]'></textarea>
        </div>
        <div class="col" style="min-width:280px">
          <label>Steuerung</label>
          <div class="row">
            <button id="btnLoadPlaylist" class="btn">üì• Playlist laden</button>
            <button id="btnStartCurrent" class="btn acc">‚ñ∂Ô∏è Runde starten (aktuell)</button>
            <button id="btnNextRound" class="btn">‚è≠Ô∏è N√§chste Runde</button>
          </div>
          <div class="tag">Aktueller Index: <span id="roundIndex">0</span></div>
        </div>
      </div>
    </div>

    <h1>Admin ¬∑ Bilder-R√§tsel Quiz</h1>

    <!-- Hauptkarte: Bild, Frage, Steuerung, Punkte -->
    <div class="card">
      <div class="row">
        <div class="col">
          <label>Bild-URL</label>
          <input id="imageUrl" placeholder="/images/sample.jpg" value="/images/sample.jpg"/>
        </div>
        <div class="col">
          <label>Countdown (Sek.)</label>
          <input id="countdown" type="number" value="15" min="3" max="120"/>
        </div>
        <div class="col">
          <label>Klick-Radius (px)</label>
          <input id="radius" type="number" value="45" min="5" max="200"/>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>Gesuchter Bereich (per Klick setzen) &amp; Live-Overlay</label>
          <div id="board" class="board" style="position:relative">
            <canvas id="overlay" style="position:absolute;inset:0;pointer-events:none"></canvas>
            <img id="img" src="/images/sample.jpg" alt="Preview"/>
            <div id="mask" class="mask" style="display:none"></div>
            <div id="target" class="marker locked" style="display:none;width:90px;height:90px"></div>
          </div>
          <div class="small">Tipp: Klicke in das Bild, um Zielkoordinaten zu setzen. Der Kreis zeigt den Radius.</div>
        </div>
        <div style="min-width:320px" class="col">
          <label>Frage</label>
          <input id="question" placeholder="Frage f√ºr die Runde (wird Spielern in der Dunkelphase angezeigt)"/>
          <div class="hr"></div>
          <label>Rundensteuerung</label>
          <div class="row">
            <button id="btnStart" class="btn acc">‚ñ∂Ô∏è Runde starten</button>
            <button id="btnRevealCircles" class="btn">üëÄ Klick-Kreise anzeigen</button>
            <button id="btnHideCircles" class="btn">üôà Klick-Kreise ausblenden</button>
            <button id="btnClearCircles" class="btn">üßπ Klick-Kreise entfernen</button>
          </div>
          <div class="row" style="margin-top:6px">
            <button id="btnRevealArea" class="btn good">üéØ Bereich aufdecken</button>
            <button id="btnRevealAuto" class="btn good">üéØ Aufl√∂sen (Auto-Weiter)</button>
            <button id="btnShowFull" class="btn warn">üñºÔ∏è Bild komplett zeigen</button>
          </div>
          <div class="hr"></div>
          <label>Teams & Punkte</label>
          <div id="teamLegend" class="small" style="margin:6px 0">Farben: Team A‚ÄìD = feste Farben</div>
          <div id="teams"></div>
        </div>
      </div>
    </div>

    <!-- Lobby -->
    <div class="card">
      <h3>Lobby / Verbindungen</h3>
      <div id="lobby"></div>
    </div>
  </div>

  <script>
    const socket = io();
    const COLORS = ["#4da3ff","#ff4d6d","#22c55e","#eab308"]; // bis zu 4 Teams
    let playlist = [];
    let roundIdx = 0;

    // ADMIN Overlay-Daten
    const adminOverlay = {
      clicks: {},              // (legacy) Spieler-Previews, falls genutzt
      teamCircles: {},         // NEU: ein Kreis pro Team
      revealTeamCircles: false // NEU: sichtbar/nicht
    };

    // Team-Status (Badges)
    const teamStatus = {
      hasCircle: {}, // teamId -> bool (irgendwo gesetzt)
      locked: {}     // teamId -> bool (eingeloggt)
    };

    const imgEl = document.getElementById('img');
    const targetEl = document.getElementById('target');
    const boardEl = document.getElementById('board');
    const maskEl = document.getElementById('mask');
    const imageUrlInput = document.getElementById('imageUrl');
    const countdownInput = document.getElementById('countdown');
    const radiusInput = document.getElementById('radius');
    const teamsEl = document.getElementById('teams');
    const lobbyEl = document.getElementById('lobby');

    // target = RAW (so wie an Server): Pixel oder {normalized:true}
    let target = {x:0,y:0};
    let radius = parseInt(radiusInput.value,10);

    // Utilities
    function boardRect(){
      const r = boardEl.getBoundingClientRect();
      return {left:r.left + window.scrollX, top:r.top + window.scrollY, width:r.width, height:r.height};
    }
    function px(v){ return v+'px'; }
    function placeMarkerAt(el, x, y, r){
      el.style.left = px(x - r);
      el.style.top = px(y - r);
      el.style.width = px(r*2);
      el.style.height = px(r*2);
      el.style.display = 'block';
    }

    // Marker f√ºr evtl. normalisierte Targets passend anzeigen
    function displayTargetMarker(t){
      if(!t || t.x==null || t.y==null){ targetEl.style.display='none'; return; }
      fitOverlay();
      let dx = t.x, dy = t.y;
      if (t.normalized || (dx <= 1 && dy <= 1)) {
        dx = dx * overlay.width;
        dy = dy * overlay.height;
      }
      placeMarkerAt(targetEl, dx, dy, radius);
    }

    imgEl.addEventListener('load', ()=>{ displayTargetMarker(target); });
    radiusInput.addEventListener('input',()=>{
      radius = parseInt(radiusInput.value||'45',10);
      if(targetEl.style.display!=='none'){
        const rect = targetEl.getBoundingClientRect();
        // Nur Gr√∂√üe neu setzen; Position bleibt zentriert
        targetEl.style.width = px(radius*2);
        targetEl.style.height = px(radius*2);
      }
      drawOverlay();
    });
    imageUrlInput.addEventListener('change', ()=>{ imgEl.src = imageUrlInput.value || '/images/sample.jpg'; });

    // Admin setzt Ziel per Klick (immer als Pixel-Rohwert senden)
    boardEl.addEventListener('click', (e)=>{
      const r = boardRect();
      const x = e.pageX - r.left;
      const y = e.pageY - r.top;
      target = {x, y}; // √ºberschreibt ggf. normalisierte Playlist-Targets
      placeMarkerAt(targetEl, x, y, radius);
    });

    /* ========= Rundensteuerung ========= */
    document.getElementById('btnStart').onclick = ()=>{
      const payload = {
        imageUrl: imageUrlInput.value || '/images/sample.jpg',
        duration: Math.max(3, parseInt(countdownInput.value||'15',10)),
        radius: Math.max(5, Math.min(200, parseInt(radiusInput.value||'45',10))),
        target, // Pixel ODER normalisiert
        question: (document.getElementById('question').value || '')
      };
      socket.emit('admin:startRound', payload);
    };

    // NEU: Team-Kreise anzeigen/ausblenden/entfernen (Mapping zum neuen Server)
    document.getElementById('btnRevealCircles').onclick = ()=> socket.emit('admin:revealTeamCircles');
    document.getElementById('btnHideCircles').onclick   = ()=> socket.emit('admin:hideTeamCircles');
    document.getElementById('btnClearCircles').onclick  = ()=> socket.emit('admin:clearTeamCircles');

    // Reveal Zielbereich etc. (wie gehabt)
    document.getElementById('btnRevealArea').onclick = ()=> socket.emit('admin:revealArea', {autoNext:false});
    document.getElementById('btnRevealAuto').onclick = ()=> socket.emit('admin:revealArea', {autoNext:true, delayMs:3000});
    document.getElementById('btnShowFull').onclick   = ()=> socket.emit('admin:showFull');

    /* ========= Teams & Punkte ========= */
    function renderTeams(state){
      teamsEl.innerHTML = '';
      const t = state.teams || {};
      Object.values(t).forEach(team=>{
        const row = document.createElement('div');
        row.className='score-row';
        const color = COLORS[team.colorIdx||0];
        const hasC  = !!teamStatus.hasCircle[team.id];
        const lock  = !!teamStatus.locked[team.id];

        row.innerHTML = `
          <div class="name tag" style="border-color:${color}">üè∑Ô∏è ${team.name}
            <span class="badge ${hasC?'ok':'muted'}">${hasC?'Kreis gesetzt':'kein Kreis'}</span>
            <span class="badge ${lock?'ok':'muted'}">${lock?'eingeloggt':'offen'}</span>
          </div>
          <div class="score tag">‚≠ê ${team.points||0}</div>
          <button class="btn good" data-id="${team.id}" data-a="plus1">+1</button>
          <button class="btn bad" data-id="${team.id}" data-a="minus1">-1</button>
          <input class="setInput" data-id="${team.id}" type="number" placeholder="¬±Punkte"/>
          <button class="btn" data-id="${team.id}" data-a="apply">Setzen</button>
        `;
        teamsEl.appendChild(row);
      });
      teamsEl.querySelectorAll('button').forEach(btn=>{
        const id = btn.getAttribute('data-id');
        const a = btn.getAttribute('data-a');
        if(a==='plus1')  btn.onclick = ()=> socket.emit('admin:adjustPoints', {teamId:id, delta: +1});
        if(a==='minus1') btn.onclick = ()=> socket.emit('admin:adjustPoints', {teamId:id, delta: -1});
        if(a==='apply')  btn.onclick = ()=> {
          const inp = btn.parentElement.querySelector('.setInput');
          const val = parseInt(inp.value||'0',10);
          socket.emit('admin:adjustPoints', {teamId:id, delta: val});
          inp.value='';
        };
      });
    }

    /* ========= Lobby ========= */
    function renderLobby(state){
      window.__statePlayers = state.players || {};
      const players = Object.values(state.players||{});
      const byTeam = {};
      players.forEach(p=>{
        if(!byTeam[p.teamId]) byTeam[p.teamId] = [];
        byTeam[p.teamId].push(p);
      });
      lobbyEl.innerHTML = Object.entries(byTeam).map(([teamId, list])=>{
        const t = (state.teams||{})[teamId];
        const tname = t ? t.name : '(Team?)';
        const color = t ? COLORS[t.colorIdx||0] : '#888';
        return `<div class="tag" style="border-color:${color}">üë• ${tname}: ${list.map(p=>p.name).join(', ')}</div>`;
      }).join(' ');
    }

    /* ========= Overlay ========= */
    const overlay = document.getElementById('overlay');
    function fitOverlay(){
      const r = boardEl.getBoundingClientRect();
      overlay.width = r.width;
      overlay.height = r.height;
    }
    window.addEventListener('resize', ()=>{ fitOverlay(); drawOverlay(); });
    new ResizeObserver(()=>{ fitOverlay(); drawOverlay(); }).observe(boardEl);

    // Zeichnet (optional) Legacy-Player-Clicks & NEU: Team-Kreise (bei Reveal)
    function drawOverlay(){
      const ctx = overlay.getContext('2d');
      ctx.clearRect(0,0,overlay.width,overlay.height);

      const teams = window.__stateTeams || {};
      const players = window.__statePlayers || {};
      ctx.font = '12px system-ui, Arial';
      ctx.textBaseline = 'top';

      // 1) (Legacy) einzelne Spieler-Clicks (falls du die noch nutzt)
      Object.entries(adminOverlay.clicks).forEach(([tid, pClicks], idx)=>{
        const color = COLORS[(teams[tid]?.colorIdx)||0] || COLORS[idx % COLORS.length];
        Object.entries(pClicks).forEach(([pid, click])=>{
          let {x,y,normalized} = click || {};
          if (normalized || (x<=1 && y<=1)) { x = x * overlay.width; y = y * overlay.height; }
          ctx.beginPath();
          ctx.strokeStyle = color;
          ctx.lineWidth = 1.5;
          ctx.setLineDash([4,3]);
          ctx.arc(x, y, radius, 0, Math.PI*2);
          ctx.stroke();
          ctx.setLineDash([]);
          ctx.beginPath();
          ctx.arc(x,y,3,0,Math.PI*2);
          ctx.fillStyle = color;
          ctx.fill();

          const pname = (players[pid]?.name) || pid.slice(0,4);
          const tname = (teams[tid]?.name) || tid;
          const label = `${tname} ¬∑ ${pname}`;
          const padding = 3, th = 16, tw = ctx.measureText(label).width + padding*2;
          const lx = Math.min(Math.max(0, x + radius + 6), overlay.width - tw);
          const ly = Math.min(Math.max(0, y - th/2), overlay.height - th);
          ctx.fillStyle = 'rgba(0,0,0,0.55)';
          ctx.fillRect(lx, ly, tw, th);
          ctx.strokeStyle = color;
          ctx.strokeRect(lx, ly, tw, th);
          ctx.fillStyle = '#e5e7eb';
          ctx.fillText(label, lx + padding, ly + 2);
        });
      });

      // 2) NEU: Team-Kreise (hell sichtbar NUR wenn reveal an)
      if(adminOverlay.revealTeamCircles){
        Object.entries(adminOverlay.teamCircles || {}).forEach(([tid, c])=>{
          if(!c) return;
          const color = COLORS[(teams[tid]?.colorIdx)||0] || '#4da3ff';
          let x = c.x, y = c.y;
          if (c.normalized || (x<=1 && y<=1)) { x = x * overlay.width; y = y * overlay.height; }
          ctx.beginPath();
          ctx.lineWidth = 3;
          ctx.strokeStyle = color;
          ctx.arc(x, y, radius, 0, Math.PI*2);
          ctx.stroke();
          ctx.beginPath();
          ctx.arc(x, y, 4, 0, Math.PI*2);
          ctx.fillStyle = color;
          ctx.fill();

          const tname = (teams[tid]?.name) || tid;
          const label = `Team-Kreis ¬∑ ${tname}`;
          const padding = 4, th = 18, tw = ctx.measureText(label).width + padding*2;
          const lx = Math.min(Math.max(0, x + radius + 8), overlay.width - tw);
          const ly = Math.min(Math.max(0, y - th/2), overlay.height - th);
          ctx.fillStyle = 'rgba(0,0,0,0.65)';
          ctx.fillRect(lx, ly, tw, th);
          ctx.strokeStyle = color;
          ctx.strokeRect(lx, ly, tw, th);
          ctx.fillStyle = '#e5e7eb';
          ctx.fillText(label, lx + padding, ly + 2);
        });
      }
    }

    /* ========= Playlist ========= */
    const playlistJsonEl = document.getElementById('playlistJson');
    const questionInput = document.getElementById('question');
    const roundIndexEl = document.getElementById('roundIndex');

    document.getElementById('btnLoadPlaylist').onclick = ()=>{
      try{
        const arr = JSON.parse(playlistJsonEl.value || '[]');
        if(!Array.isArray(arr)) throw new Error('Keine Array-Playlist');
        playlist = arr;
        roundIdx = 0;
        roundIndexEl.textContent = roundIdx;
        if(playlist[0]){
          imageUrlInput.value = playlist[0].imageUrl || imageUrlInput.value;
          countdownInput.value = (playlist[0].duration || countdownInput.value);
          radiusInput.value = (playlist[0].radius || radiusInput.value);
          questionInput.value = (playlist[0].question || '');
          imgEl.src = imageUrlInput.value;
          if(playlist[0].target){
            target = playlist[0].target;     // RAW (evtl. normalized)
            displayTargetMarker(target);      // Anzeige in Pixel
          }else{
            target = {x:0,y:0};
            targetEl.style.display='none';
          }
        }
        alert('Playlist geladen: '+playlist.length+' Runden');
        updateRoundProgress();
      }catch(e){
        alert('Fehler beim Laden der Playlist: '+e.message);
      }
    };

    document.getElementById('btnStartCurrent').onclick = ()=>{ 
      updateRoundProgress();
      const payload = {
        imageUrl: imageUrlInput.value || '/images/sample.svg',
        duration: Math.max(3, parseInt(countdownInput.value||'15',10)),
        radius: Math.max(5, Math.min(200, parseInt(radiusInput.value||'45',10))),
        target, // RAW (Pixel oder normalisiert)
        question: questionInput.value || ''
      };
      socket.emit('admin:startRound', payload);
    };

    document.getElementById('btnNextRound').onclick = ()=>{
      if(!playlist.length){ alert('Bitte zuerst eine Playlist laden.'); return; }
      roundIdx = (roundIdx + 1) % playlist.length;
      roundIndexEl.textContent = roundIdx;
      const r = playlist[roundIdx];
      imageUrlInput.value = r.imageUrl || imageUrlInput.value;
      countdownInput.value = r.duration || countdownInput.value;
      radiusInput.value = r.radius || radiusInput.value;
      radius = parseInt(radiusInput.value,10);
      questionInput.value = r.question || '';
      imgEl.src = imageUrlInput.value;
      if(r.target){
        target = r.target;               // RAW √ºbernehmen
        displayTargetMarker(target);     // Anzeige in Pixel
      }else{
        target = {x:0,y:0};
        targetEl.style.display='none';
      }
      updateRoundProgress();
    };

    /* ========= Turn-Control ========= */
    function renderTurn(state){
      const sel = document.getElementById('turnSelect');
      const now = document.getElementById('turnNow');
      const teams = state.teams || {};
      const sorted = Object.values(teams).sort((a,b)=> a.name.localeCompare(b.name));
      sel.innerHTML = sorted.map(t=> `<option value="${t.id}">${t.name}</option>`).join('');
      if(state.turnTeamId && teams[state.turnTeamId]){
        sel.value = state.turnTeamId;
        now.textContent = teams[state.turnTeamId].name;
        now.style.color = COLORS[teams[state.turnTeamId].colorIdx || 0];
      }else{
        now.textContent = '‚Äì';
        now.style.color = '';
      }
    }
    document.getElementById('btnPrevTurn').onclick = ()=> socket.emit('admin:prevTurn');
    document.getElementById('btnNextTurn').onclick = ()=> socket.emit('admin:nextTurn');
    document.getElementById('turnSelect').onchange = (e)=> socket.emit('admin:setTurn', {teamId:e.target.value});
    socket.on('turn:update', ({teamId})=>{
      const teams = window.__stateTeams || {};
      const now = document.getElementById('turnNow');
      if(teams[teamId]){
        now.textContent = teams[teamId].name;
        now.style.color = COLORS[teams[teamId].colorIdx || 0];
        const sel = document.getElementById('turnSelect');
        sel.value = teamId;
      }
    });

    /* ========= State/Events vom Server ========= */
    // Global State
    socket.on('state', s=>{
      window.__stateTeams = s.teams || {};
      renderTeams(s);
      renderLobby(s);
      renderTurn(s);
      fitOverlay();
      drawOverlay();
      displayTargetMarker(target);
    });

    // (Legacy) Live-Player-Clicks
    socket.on('admin:liveClick', ({teamId, playerId, x, y, normalized})=>{
      adminOverlay.clicks[teamId] = adminOverlay.clicks[teamId] || {};
      adminOverlay.clicks[teamId][playerId] = {x,y,normalized: !!normalized};
      drawOverlay();
    });

    // Team-Kreis wurde gesetzt (nur Status f√ºrs Admin-UI)
    socket.on('admin:teamCircleSet', ({teamId})=>{
      teamStatus.hasCircle[teamId] = true;
      renderTeams({teams: window.__stateTeams});
    });

    // Team hat best√§tigt (eingeloggt)
    socket.on('admin:teamLocked', ({teamId})=>{
      teamStatus.locked[teamId] = true;
      renderTeams({teams: window.__stateTeams});
    });

    // Team wieder entsperrt
    socket.on('admin:teamUnlocked', ({teamId})=>{
      teamStatus.locked[teamId] = false;
      renderTeams({teams: window.__stateTeams});
    });

    // Server: neue Round-Config (Reset Overlay/Status)
    socket.on('round:config', ()=>{
      adminOverlay.clicks = {};
      adminOverlay.teamCircles = {};
      adminOverlay.revealTeamCircles = false;
      Object.keys(teamStatus.hasCircle).forEach(k=> delete teamStatus.hasCircle[k]);
      Object.keys(teamStatus.locked).forEach(k=> delete teamStatus.locked[k]);
      drawOverlay();
      renderTeams({teams: window.__stateTeams});
    });

    // NEU: Reveal/Hide Team-Kreise inkl. Daten
    socket.on('round:revealTeamCircles', ({reveal, teamCircles})=>{
      adminOverlay.revealTeamCircles = !!reveal;
      if(teamCircles) adminOverlay.teamCircles = teamCircles;
      drawOverlay();
    });

    // NEU: Clear Team-Kreise
    socket.on('round:clearTeamCircles', ()=>{
      adminOverlay.teamCircles = {};
      adminOverlay.revealTeamCircles = false;
      Object.keys(teamStatus.hasCircle).forEach(k=> delete teamStatus.hasCircle[k]);
      Object.keys(teamStatus.locked).forEach(k=> delete teamStatus.locked[k]);
      drawOverlay();
      renderTeams({teams: window.__stateTeams});
    });

    // History rendern
    function renderHistory(list){
      const el = document.getElementById('historyList');
      if(!Array.isArray(list) || !list.length){ el.innerHTML = '<div class="small">Noch keine Runden.</div>'; return; }
      el.innerHTML = list.slice().reverse().map((h)=>{
        const date = new Date(h.ts).toLocaleTimeString();
        const winners = (h.winners||[]).map(tid=> (window.__stateTeams[tid]?.name||tid)).join(', ') || '‚Äî';
        return `<div class="tag" style="display:block;margin:4px 0">
          <div><strong>${date}</strong> ‚Äì ${h.question||'(ohne Frage)'} ‚Äì Gewinner: ${winners}</div>
          <div class="small">${h.imageUrl}</div>
        </div>`;
      }).join('');
    }
    socket.on('admin:history', renderHistory);

    // Fortschritt
    function updateRoundProgress(){
      const total = playlist.length || '‚Äì';
      const cur = (playlist.length ? (roundIdx+1) : '‚Äì');
      document.getElementById('roundProgress').textContent = `${cur}/${total}`;
      document.getElementById('roundIndex').textContent = (playlist.length ? roundIdx : 0);
    }

    // Auto-Weiter-Request vom Server ‚Üí n√§chste Playlist-Runde laden und starten
    socket.on('admin:requestNext', ()=>{
      if(playlist.length){
        document.getElementById('btnNextRound').click();
        document.getElementById('btnStartCurrent').click();
      }
    });

    // Upload
    async function readFilesAsDataUrls(files){
      const arr = [];
      for(const f of files){
        const dataUrl = await new Promise(res=>{
          const r = new FileReader();
          r.onload = ()=> res(r.result);
          r.readAsDataURL(f);
        });
        arr.push({name:f.name, dataUrl});
      }
      return arr;
    }
    document.getElementById('btnUpload').onclick = async ()=>{
      const inp = document.getElementById('fileInput');
      if(!inp.files.length) return alert('Bitte Dateien w√§hlen.');
      const files = await readFilesAsDataUrls(inp.files);
      const resp = await fetch('/admin/upload', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({files})});
      const data = await resp.json();
      if(!data.ok){ alert('Upload fehlgeschlagen: '+(data.error||'unknown')); return; }
      const list = document.getElementById('uploadList');
      list.innerHTML = data.urls.map(u=> `<a href="${u}" target="_blank">${u}</a> ‚Ä¢ <button class="btn" data-url="${u}">als Bild w√§hlen</button>`).join('<br>');
      list.querySelectorAll('button').forEach(b=>{
        b.onclick = ()=>{
          const u = b.getAttribute('data-url');
          imageUrlInput.value = u;
          imgEl.src = u;
          alert('Bild gesetzt: '+u);
        };
      });
    };

    // Admin-Handshake
    socket.emit('admin:hello');

    // Overlay erstmal passend setzen
    const overlay = document.getElementById('overlay');
    fitOverlay();
    drawOverlay();
  </script>
</body>
</html>

<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Spieler · Bilder-Rätsel Quiz</title>
  <link rel="stylesheet" href="/style.css"/>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Spieler · Bilder-Rätsel Quiz</h1>

    <div id="joinCard" class="card">
      <div id="liveLobby" class="card" style="display:block">
        <h3>Teams & Spieler (Lobby)</h3>
        <div id="teamGrid"></div>
      </div>

      <div class="row">
        <div class="col">
          <label>Dein Spielername</label>
          <input id="playerName" placeholder="z. B. Dennis"/>
        </div>
        <div class="col">
          <label>Team wählen oder neu eingeben (2–4 Teams gesamt)</label>
          <input id="teamName" placeholder="Teamname"/>
        </div>
        <div class="col" style="align-self:flex-end">
          <button id="btnJoin" class="btn acc">Beitreten</button>
        </div>
      </div>
      <div class="small">Hinweis: Dein Team-Partner sieht live deinen Klick-Marker – andere Teams nicht.</div>
    </div>

    <div id="gameCard" class="card" style="display:none">
      <div class="row" style="align-items:center;justify-content:space-between">
        <div class="tag">Frage: <span id="question">–</span></div>
        <div class="tag">Team: <span id="myTeamName"></span></div>
        <div class="tag">Countdown: <span id="countdown">–</span></div>
        <div class="tag">Status: <span id="status">Warten…</span></div>
        <div class="tag">Dran: <span id="turnNow">–</span></div>
      </div>
      <div class="hr"></div>
      <div class="center">
        <div id="board" class="board">
          <img id="img" src="" alt=""/>
          <div id="mask" class="mask" style="display:none"></div>
          <div id="myMarker" class="marker" style="display:none"></div>
          <div id="mateMarker" class="marker team" style="display:none"></div>
          <div id="lockedMarker" class="marker locked" style="display:none"></div>
        </div>
      </div>
      
      <div class="hr"></div>
      <div>
        <h3>Teams & Punkte</h3>
        <div id="sidebarTeams"></div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnLock" class="btn good">✅ Fertig (einloggen)</button>
        <button id="btnUnlock" class="btn warn" style="display:none">🔓 Änderung</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

  <script>
    const socket = io();
    const COLORS = ['#4da3ff','#ff4d6d','#22c55e','#eab308'];
    window.__stateTeams = {}; 
    window.__statePlayers = {};

    // Turn-Mirror (welches Team ist dran)
    let __turnTeamId = null;

    const joinCard = document.getElementById('joinCard');
    const gameCard = document.getElementById('gameCard');
    const playerNameInput = document.getElementById('playerName');
    const teamNameInput = document.getElementById('teamName');
    const btnJoin = document.getElementById('btnJoin');
    const myTeamNameEl = document.getElementById('myTeamName');
    const countdownEl = document.getElementById('countdown');
    const statusEl = document.getElementById('status');
    const imgEl = document.getElementById('img');
    const boardEl = document.getElementById('board');
    const maskEl = document.getElementById('mask');
    const myMarker = document.getElementById('myMarker');
    const mateMarker = document.getElementById('mateMarker');
    const lockedMarker = document.getElementById('lockedMarker');
    const btnLock = document.getElementById('btnLock');
    const btnUnlock = document.getElementById('btnUnlock');
    const toast = document.getElementById('toast');
    const questionEl = document.getElementById('question');
    const turnNowEl = document.getElementById('turnNow');

    let my = {id:null, name:'', teamId:null};
    let canClick = false;
    let radius = 45;
    let locked = false;

    // Runde-Infos (für normalized Reveal etc.)
    let roundIsNormalized = false;

    function showToast(msg){
      toast.textContent = msg;
      toast.style.display = 'block';
      setTimeout(()=> toast.style.display='none', 2500);
    }

    function boardRect(){
      const r = boardEl.getBoundingClientRect();
      return {left:r.left + window.scrollX, top:r.top + window.scrollY, width:r.width, height:r.height};
    }
    function px(v){ return v+'px'; }
    
    function teamColor(t){
      const idx = (t && typeof t.colorIdx==='number') ? t.colorIdx : 0;
      return COLORS[idx % COLORS.length];
    }

    // ---- Lobby-Karten ----
    function renderLobbyTeams(){
      const grid = document.getElementById('teamGrid');
      const teams = window.__stateTeams || {};
      const players = window.__statePlayers || {};
      const grouped = {};
      Object.values(players).forEach(p=>{
        grouped[p.teamId] = grouped[p.teamId] || [];
        grouped[p.teamId].push(p);
      });
      const cards = Object.values(teams).map(t=>{
        const list = grouped[t.id] || [];
        const full = list.length >= 2;
        const color = teamColor(t);
        const btn = full ? `<button class="btn" disabled>Team voll</button>` : `<button class="btn acc" data-join="${t.id}">Team beitreten</button>`;
        return `<div class="card" style="border-left:6px solid ${color}; margin:6px 0">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
            <div>
              <div class="tag" style="border-color:${color}">🏷️ ${t.name}</div>
              <div class="small">Punkte: <strong>${t.points||0}</strong> • Spieler (${list.length}/2): ${list.map(p=>p.name).join(', ')||'—'}</div>
            </div>
            ${btn}
          </div>
        </div>`;
      }).join('') || '<div class="small">Noch keine Teams – gib oben einen Teamnamen ein, um das erste zu erstellen.</div>';
      grid.innerHTML = cards;
      grid.querySelectorAll('button[data-join]').forEach(b=>{
        b.onclick = ()=>{
          const teamId = b.getAttribute('data-join');
          const t = teams[teamId];
          if(t){ teamNameInput.value = t.name; }
        };
      });
    }

    // ---- Sidebar Teams & Punkte ----
    function renderSidebar(){
      const el = document.getElementById('sidebarTeams');
      const teams = Object.values(window.__stateTeams||{});
      const players = window.__statePlayers || {};
      const grouped = {};
      Object.values(players).forEach(p=>{
        grouped[p.teamId] = grouped[p.teamId] || [];
        grouped[p.teamId].push(p);
      });
      el.innerHTML = teams.map(t=>{
        const color = teamColor(t);
        const list = grouped[t.id] || [];
        return `<div class="tag" style="display:block;margin:4px 0;border-color:${color}">
          ⭐ ${t.points||0} — ${t.name} <span class="small">(${list.map(p=>p.name).join(', ')||'—'})</span>
        </div>`;
      }).join('');
    }

    // ---- Marker setzen ----
    function placeMarkerAt(el, x, y, r){
      el.style.left = px(x);
      el.style.top = px(y);
      el.style.width = px(r*2);
      el.style.height = px(r*2);
      el.style.display = 'block';
    }

    // ---- Turn-Helpers (nur aktuelles Team darf klicken) ----
    function isMyTurn(){
      return !!(my && my.teamId && __turnTeamId && my.teamId === __turnTeamId);
    }
    function renderTurnPlayer(state){
      const teams = state.teams || {};
      const id = state.turnTeamId;
      if(id && teams[id]){
        turnNowEl.textContent = teams[id].name;
        turnNowEl.style.color = COLORS[teams[id].colorIdx || 0];
      }else{
        turnNowEl.textContent = '–';
        turnNowEl.style.color = '';
      }
    }
    function updateBoardInteractivity(){
      const enable = isMyTurn() && canClick && !locked;
      boardEl.style.pointerEvents = enable ? 'auto' : 'none';
      boardEl.style.opacity = enable ? '1' : '0.65';
    }

    // ---- Join ----
    btnJoin.onclick = ()=>{
      const name = (playerNameInput.value||'').trim();
      const teamName = (teamNameInput.value||'').trim();
      if(!name || !teamName){ showToast('Bitte Name und Team ausfüllen.'); return; }
      socket.emit('player:join', {name, teamName});
    };

    socket.on('player:accepted', (p)=>{
      my = p;
      myTeamNameEl.textContent = p.teamName;
      joinCard.style.display='none';
      gameCard.style.display='block';
    });

    // ---- Globaler State ----
    socket.on('state', s=>{
      window.__stateTeams = s.teams||{};
      window.__statePlayers = s.players||{};
      __turnTeamId = s.turnTeamId || null;
      renderLobbyTeams();
      renderSidebar();
      renderTurnPlayer(s);
      updateBoardInteractivity();
    });

    // turn:update (schnelles Live-Update)
    socket.on('turn:update', ({teamId})=>{
      __turnTeamId = teamId || null;
      renderTurnPlayer({teams: window.__stateTeams, turnTeamId: __turnTeamId});
      updateBoardInteractivity();
    });

    // ---- Rundenfluss ----
    socket.on('round:config', (cfg)=>{
      // Reset state
      locked=false; 
      canClick=false;
      myMarker.style.display='none';
      mateMarker.style.display='none';
      lockedMarker.style.display='none';
      maskEl.style.display='none';
      statusEl.textContent = 'Countdown läuft…';

      imgEl.src = cfg.imageUrl;
      radius = cfg.radius;
      countdownEl.textContent = cfg.duration;
      questionEl.textContent = cfg.question || '–';
      roundIsNormalized = !!cfg.isNormalized; // merken, falls Reveal kommt
      updateBoardInteractivity();
    });

    socket.on('round:tick', (t)=>{
      countdownEl.textContent = t;
    });

    socket.on('round:dark', ()=>{
      maskEl.style.display='block';
      // Nur klicken, wenn eigenes Team dran ist
      canClick = isMyTurn();
      statusEl.textContent = canClick ? 'Klicke auf die gesuchte Stelle…' : 'Warten – anderes Team ist dran…';
      updateBoardInteractivity();
    });

    // Klick aufs Board – SENDEN ALS NORMALIZED (0..1)
    boardEl.addEventListener('click', (e)=>{
      if(!canClick || locked) return;
      if(!isMyTurn()){
        showToast('Dein Team ist nicht dran.');
        updateBoardInteractivity();
        return;
      }
      const rect = imgEl.getBoundingClientRect();
      const relX = (e.clientX - rect.left) / rect.width;
      const relY = (e.clientY - rect.top) / rect.height;

      // Vorschau lokal in Pixel
      placeMarkerAt(myMarker, relX * rect.width, relY * rect.height, radius);

      // An Server senden – normalisiert
      socket.emit('player:clickUpdate', { x: relX, y: relY, normalized: true });
    });

    // Lock / Unlock (nur wenn dran)
    btnLock.onclick = ()=>{
      if(!isMyTurn()){
        showToast('Dein Team ist nicht dran.');
        return;
      }
      if(myMarker.style.display==='none'){ showToast('Bitte zuerst klicken.'); return; }
      locked = true; 
      canClick=false;
      btnLock.style.display='none';
      btnUnlock.style.display='inline-block';
      lockedMarker.style.left = myMarker.style.left;
      lockedMarker.style.top = myMarker.style.top;
      lockedMarker.style.width = myMarker.style.width;
      lockedMarker.style.height = myMarker.style.height;
      lockedMarker.style.display = 'block';
      socket.emit('player:lock');
      statusEl.textContent = 'Eingeloggt – warte auf Auflösung…';
      updateBoardInteractivity();
    };

    btnUnlock.onclick = ()=>{
      if(!isMyTurn()){
        showToast('Dein Team ist nicht dran.');
        return;
      }
      locked = false; 
      canClick=true;
      btnLock.style.display='inline-block';
      btnUnlock.style.display='none';
      lockedMarker.style.display='none';
      socket.emit('player:unlock');
      statusEl.textContent = 'Änderung möglich – erneut klicken und einloggen.';
      updateBoardInteractivity();
    };

    // Teammate live marker (hidden from other teams) – unterstützt normalized
    socket.on('team:mateClick', ({x,y,normalized})=>{
      if(!canClick) return;
      const rect = imgEl.getBoundingClientRect();
      const px = (normalized || (x<=1 && y<=1)) ? x * rect.width : x;
      const py = (normalized || (x<=1 && y<=1)) ? y * rect.height : y;
      placeMarkerAt(mateMarker, px, py, radius);
    });

    // Nach Auflösung
    socket.on('round:revealGuesses', (teamMarkers)=>{
      statusEl.textContent = 'Klicks sichtbar (Team-weise)';
    });

    // Reveal – unterstützt normalized Target
    socket.on('round:revealArea', ({target, radius, isNormalized})=>{
      const rect = imgEl.getBoundingClientRect();
      const tx = (isNormalized || roundIsNormalized) ? target.x * rect.width  : target.x;
      const ty = (isNormalized || roundIsNormalized) ? target.y * rect.height : target.y;
      maskEl.style.background = `radial-gradient(circle ${radius}px at ${tx}px ${ty}px,
        rgba(0,0,0,0) 0%, rgba(0,0,0,0) ${radius-1}px, rgba(0,0,0,.88) ${radius}px)`;
    });

    socket.on('round:showFull', ()=>{
      maskEl.style.display='none';
      statusEl.textContent = 'Gesamtes Bild sichtbar';
      canClick = false;
      updateBoardInteractivity();
    });

    // Utility updates
    socket.on('toast', showToast);
  </script>
</body>
</html>

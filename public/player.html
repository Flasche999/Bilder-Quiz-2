<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Spieler · Bilder-Rätsel Quiz</title>
  <link rel="stylesheet" href="/style.css"/>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    .hidden{display:none}
    .marker{position:absolute;border:2px dashed #7aa2ff;border-radius:999px;pointer-events:none;mix-blend-mode:screen}
    .marker.team{border-color:#22c55e}
    .marker.locked{border-style:solid;border-color:#eab308}
    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111827;color:#e5e7eb;border:1px solid rgba(255,255,255,.15);padding:8px 12px;border-radius:10px;z-index:9999}
    .board{position:relative;display:inline-block}
    .board img{max-width:100%;display:block;border-radius:12px}
    .mask{position:absolute;inset:0;background:#000;opacity:1;border-radius:12px;pointer-events:none}
  </style>
</head>
<body>
  <div class="container">
    <h1>Spieler · Bilder-Rätsel Quiz</h1>

    <div id="joinCard" class="card">
      <div id="liveLobby" class="card" style="display:block">
        <h3>Teams & Spieler (Lobby)</h3>
        <div id="teamGrid"></div>
      </div>

      <div class="row">
        <div class="col">
          <label>Dein Spielername</label>
          <input id="playerName" placeholder="z. B. Elias stinkt XD"/>
        </div>
        <div class="col">
          <label>Team wählen oder neu eingeben (2–4 Teams gesamt)</label>
          <input id="teamName" placeholder="Teamname"/>
        </div>
        <div class="col" style="align-self:flex-end">
          <button id="btnJoin" class="btn acc">Beitreten</button>
        </div>
      </div>
      <div class="small">Hinweis: Dein Team-Partner kann den gemeinsamen Kreis ebenfalls setzen/verschieben. Erst nach „✅ Fertig“ ist euer Kreis fix.</div>
    </div>

    <div id="gameCard" class="card hidden">
      <div class="row" style="align-items:center;justify-content:space-between">
        <div class="tag">Frage: <span id="question">–</span></div>
        <div class="tag">Team: <span id="myTeamName"></span></div>
        <div class="tag">Countdown: <span id="countdown">–</span></div>
        <div class="tag">Status: <span id="status">Warten…</span></div>
        <div class="tag">Dran: <span id="turnNow">–</span></div>
      </div>
      <div class="hr"></div>
      <div class="center">
        <div id="board" class="board" style="pointer-events:none;opacity:.65">
          <img id="img" src="" alt=""/>
          <div id="mask" class="mask hidden"></div>

          <!-- Eigener Team-Kreis (lokale Vorschau) -->
          <div id="teamCircle" class="marker" style="display:none"></div>
          <!-- Vorschau vom Teammate -->
          <div id="mateMarker" class="marker team" style="display:none"></div>
          <!-- Fixierter Kreis nach Bestätigen -->
          <div id="lockedMarker" class="marker locked" style="display:none"></div>

          <!-- (optional) Fremd-Kreise bei Reveal -->
          <div id="othersLayer" style="position:absolute;inset:0;pointer-events:none"></div>
        </div>
      </div>
      
      <div class="hr"></div>
      <div>
        <h3>Teams & Punkte</h3>
        <div id="sidebarTeams"></div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnLock" class="btn good">✅ Fertig (einloggen)</button>
        <button id="btnUnlock" class="btn warn hidden">🔓 Änderung</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hidden"></div>

  <script>
    const socket = io();
    const COLORS = ['#4da3ff','#ff4d6d','#22c55e','#eab308'];
    window.__stateTeams = {}; 
    window.__statePlayers = {};

    // Beim (Re-)Connect aktuellen Zustand holen
    socket.on('connect', ()=> socket.emit('player:hello'));

    // Turn-Mirror
    let __turnTeamId = null;

    const joinCard = document.getElementById('joinCard');
    const gameCard = document.getElementById('gameCard');
    const playerNameInput = document.getElementById('playerName');
    const teamNameInput = document.getElementById('teamName');
    const btnJoin = document.getElementById('btnJoin');
    const myTeamNameEl = document.getElementById('myTeamName');
    const countdownEl = document.getElementById('countdown');
    const statusEl = document.getElementById('status');
    const imgEl = document.getElementById('img');
    const boardEl = document.getElementById('board');
    const maskEl = document.getElementById('mask');
    const teamCircle = document.getElementById('teamCircle');
    const mateMarker = document.getElementById('mateMarker');
    const lockedMarker = document.getElementById('lockedMarker');
    const othersLayer = document.getElementById('othersLayer');
    const btnLock = document.getElementById('btnLock');
    const btnUnlock = document.getElementById('btnUnlock');
    const toast = document.getElementById('toast');
    const questionEl = document.getElementById('question');
    const turnNowEl = document.getElementById('turnNow');

    let my = {id:null, name:'', teamId:null};
    let canClick = false;
    let radius = 45;
    let locked = false;

    // Runde-Infos
    let roundIsNormalized = false;
    let storedQuestion = '–';      // Frage-Text wird erst in Dunkelphase gezeigt

    /* ---------- Utils ---------- */
    function show(el){ el.classList.remove('hidden'); }
    function hide(el){ el.classList.add('hidden'); }
    function showToast(msg){
      toast.textContent = msg;
      show(toast);
      setTimeout(()=> hide(toast), 2200);
    }
    function boardRect(){
      const r = imgEl.getBoundingClientRect();
      return {left:r.left + window.scrollX, top:r.top + window.scrollY, width:r.width, height:r.height};
    }
    function px(v){ return v+'px'; }
    function teamColor(t){
      const idx = (t && typeof t.colorIdx==='number') ? t.colorIdx : 0;
      return COLORS[idx % COLORS.length];
    }
    function placeMarkerAt(el, x, y, r){
      el.style.left = px(x - r);
      el.style.top  = px(y - r);
      el.style.width  = px(r*2);
      el.style.height = px(r*2);
      el.style.display = 'block';
    }
    function clearLayer(el){ el.innerHTML=''; }

    /* ---------- Lobby-Karten ---------- */
    function renderLobbyTeams(){
      const grid = document.getElementById('teamGrid');
      const teams = window.__stateTeams || {};
      const players = window.__statePlayers || {};
      const grouped = {};
      Object.values(players).forEach(p=>{
        grouped[p.teamId] = grouped[p.teamId] || [];
        grouped[p.teamId].push(p);
      });
      const cards = Object.values(teams).map(t=>{
        const list = grouped[t.id] || [];
        const full = list.length >= 2;
        const color = teamColor(t);
        const btn = full ? `<button class="btn" disabled>Team voll</button>` : `<button class="btn acc" data-join="${t.id}">Team beitreten</button>`;
        return `<div class="card" style="border-left:6px solid ${color}; margin:6px 0">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
            <div>
              <div class="tag" style="border-color:${color}">🏷️ ${t.name}</div>
              <div class="small">Punkte: <strong>${t.points||0}</strong> • Spieler (${list.length}/2): ${list.map(p=>p.name).join(', ')||'—'}</div>
            </div>
            ${btn}
          </div>
        </div>`;
      }).join('') || '<div class="small">Noch keine Teams – gib oben einen Teamnamen ein, um das erste zu erstellen.</div>';
      grid.innerHTML = cards;
      grid.querySelectorAll('button[data-join]').forEach(b=>{
        b.onclick = ()=>{
          const teamId = b.getAttribute('data-join');
          const t = teams[teamId];
          if(t){ teamNameInput.value = t.name; }
        };
      });
    }

    /* ---------- Sidebar Teams & Punkte ---------- */
    function renderSidebar(){
      const el = document.getElementById('sidebarTeams');
      const teams = Object.values(window.__stateTeams||{});
      const players = window.__statePlayers || {};
      const grouped = {};
      Object.values(players).forEach(p=>{
        grouped[p.teamId] = grouped[p.teamId] || [];
        grouped[p.teamId].push(p);
      });
      el.innerHTML = teams.map(t=>{
        const color = teamColor(t);
        const list = grouped[t.id] || [];
        return `<div class="tag" style="display:block;margin:4px 0;border-color:${color}">
          ⭐ ${t.points||0} — ${t.name} <span class="small">(${list.map(p=>p.name).join(', ')||'—'})</span>
        </div>`;
      }).join('');
    }

    /* ---------- Turn ---------- */
    function isMyTurn(){
      return !!(my && my.teamId && __turnTeamId && my.teamId === __turnTeamId);
    }
    function renderTurnPlayer(state){
      const teams = state.teams || {};
      const id = state.turnTeamId;
      if(id && teams[id]){
        turnNowEl.textContent = teams[id].name;
        turnNowEl.style.color = COLORS[teams[id].colorIdx || 0];
      }else{
        turnNowEl.textContent = '–';
        turnNowEl.style.color = '';
      }
    }
    function updateBoardInteractivity(){
      const enable = isMyTurn() && canClick && !locked;
      boardEl.style.pointerEvents = enable ? 'auto' : 'none';
      boardEl.style.opacity = enable ? '1' : '.65';
    }

    /* ---------- Join ---------- */
    btnJoin.onclick = ()=>{
      const name = (playerNameInput.value||'').trim();
      const teamName = (teamNameInput.value||'').trim();
      if(!name || !teamName){ showToast('Bitte Name und Team ausfüllen.'); return; }
      socket.emit('player:join', {name, teamName});
    };
    socket.on('player:accepted', (p)=>{
      my = p;
      myTeamNameEl.textContent = p.teamName;
      hide(joinCard);
      show(gameCard);
    });

    /* ---------- Globaler State ---------- */
    socket.on('state', s=>{
      window.__stateTeams = s.teams||{};
      window.__statePlayers = s.players||{};
      __turnTeamId = s.turnTeamId || null;
      renderLobbyTeams();
      renderSidebar();
      renderTurnPlayer(s);
      updateBoardInteractivity();
    });

    socket.on('turn:update', ({teamId})=>{
      __turnTeamId = teamId || null;
      renderTurnPlayer({teams: window.__stateTeams, turnTeamId: __turnTeamId});
      updateBoardInteractivity();
    });

    /* ---------- Rundenfluss ---------- */
    socket.on('round:config', (cfg)=>{
      // Reset
      locked=false; 
      canClick=false;
      [teamCircle, mateMarker, lockedMarker].forEach(el=> el.style.display='none');
      hide(maskEl);
      clearLayer(othersLayer);
      statusEl.textContent = 'Countdown läuft…';

      imgEl.src = cfg.imageUrl;
      radius = cfg.radius;
      countdownEl.textContent = cfg.duration;

      // Frage erst in Dark zeigen
      storedQuestion = cfg.question || '–';
      questionEl.textContent = '–';

      roundIsNormalized = !!cfg.isNormalized;
      updateBoardInteractivity();
    });

    socket.on('round:tick', (t)=>{ countdownEl.textContent = t; });

    socket.on('round:dark', ()=>{
      // Frage erscheint jetzt erst
      questionEl.textContent = storedQuestion;
      show(maskEl);                 // 100% schwarz
      canClick = isMyTurn();        // nur eigenes Team darf klicken
      statusEl.textContent = canClick ? 'Klicke auf die gesuchte Stelle…' : 'Warten – anderes Team ist dran…';
      updateBoardInteractivity();
    });

    /* ---------- Gemeinsamer Team-Kreis setzen (NORMALISIERT senden) ---------- */
    boardEl.addEventListener('click', (e)=>{
      if(!canClick || locked) return;
      if(!isMyTurn()){
        showToast('Dein Team ist nicht dran.');
        updateBoardInteractivity();
        return;
      }
      const rect = boardRect();
      const relX = (e.pageX - rect.left) / rect.width;
      const relY = (e.pageY - rect.top)  / rect.height;

      // Lokale Vorschau (Pixel)
      placeMarkerAt(teamCircle, relX * rect.width, relY * rect.height, radius);

      // An Server – EIN Kreis pro Team (beide Spieler dürfen)
      socket.emit('team:setCircle', { x: relX, y: relY, normalized: true });
    });

    // Teammate-Preview des Team-Kreises
    socket.on('team:circlePreview', ({x,y,normalized})=>{
      const rect = boardRect();
      const px = (normalized || (x<=1 && y<=1)) ? x * rect.width : x;
      const py = (normalized || (y<=1)) ? y * rect.height : y;
      placeMarkerAt(mateMarker, px, py, radius);
    });

    /* ---------- Bestätigen / Entsperren ---------- */
    btnLock.onclick = ()=>{
      if(!isMyTurn()){ showToast('Dein Team ist nicht dran.'); return; }
      if(teamCircle.style.display==='none'){ showToast('Bitte zuerst klicken.'); return; }
      locked = true; 
      canClick=false;
      btnLock.classList.add('hidden');
      btnUnlock.classList.remove('hidden');

      // Fixierten Marker an gleiche Stelle legen
      lockedMarker.style.left = teamCircle.style.left;
      lockedMarker.style.top  = teamCircle.style.top;
      lockedMarker.style.width  = teamCircle.style.width;
      lockedMarker.style.height = teamCircle.style.height;
      lockedMarker.style.display = 'block';

      socket.emit('team:confirm');
      statusEl.textContent = 'Eingeloggt – warte auf Auflösung…';
      updateBoardInteractivity();
    };

    btnUnlock.onclick = ()=>{
      if(!isMyTurn()){ showToast('Dein Team ist nicht dran.'); return; }
      locked = false; 
      canClick=true;
      btnLock.classList.remove('hidden');
      btnUnlock.classList.add('hidden');
      lockedMarker.style.display = 'none';
      socket.emit('team:unconfirm');
      statusEl.textContent = 'Änderung möglich – erneut klicken und einloggen.';
      updateBoardInteractivity();
    };

    // Admin signalisiert Team-Lock (falls Partner gelockt hat)
    socket.on('admin:teamLocked', ({teamId})=>{
      if(my.teamId !== teamId) return;
      locked = true; canClick=false;
      btnLock.classList.add('hidden');
      btnUnlock.classList.remove('hidden');
      // Übernehme aktuelle Kreis-Position als locked
      lockedMarker.style.left = teamCircle.style.left;
      lockedMarker.style.top  = teamCircle.style.top;
      lockedMarker.style.width  = teamCircle.style.width;
      lockedMarker.style.height = teamCircle.style.height;
      lockedMarker.style.display = 'block';
      statusEl.textContent = 'Eingeloggt – warte auf Auflösung…';
      updateBoardInteractivity();
    });
    socket.on('admin:teamUnlocked', ({teamId})=>{
      if(my.teamId !== teamId) return;
      locked = false; canClick = isMyTurn();
      btnLock.classList.remove('hidden');
      btnUnlock.classList.add('hidden');
      lockedMarker.style.display = 'none';
      statusEl.textContent = canClick ? 'Klicke auf die gesuchte Stelle…' : 'Warten – anderes Team ist dran…';
      updateBoardInteractivity();
    });

    /* ---------- Admin: Klick-Kreise anzeigen/ausblenden/entfernen ---------- */
    // Reveal Team-Kreise (alle Teams) – nur Kreise, keine Player-Bubbles
    socket.on('round:revealTeamCircles', ({reveal, teamCircles})=>{
      clearLayer(othersLayer);
      if(!reveal){ return; }
      const rect = boardRect();
      const teams = window.__stateTeams || {};
      Object.entries(teamCircles||{}).forEach(([tid, c])=>{
        if(!c) return;
        let x = c.x, y = c.y;
        if (c.normalized || (x<=1 && y<=1)){ x *= rect.width; y *= rect.height; }
        const el = document.createElement('div');
        el.className = 'marker other';
        el.style.position = 'absolute';
        el.style.border = '2px solid ' + (teams[tid] ? COLORS[teams[tid].colorIdx||0] : '#7aa2ff');
        el.style.borderRadius = '999px';
        el.style.left = px(x - radius);
        el.style.top  = px(y - radius);
        el.style.width  = px(radius*2);
        el.style.height = px(radius*2);
        othersLayer.appendChild(el);
      });
    });

    // Klick-Kreise komplett löschen (z. B. neue Runde oder Admin „🧹“)
    socket.on('round:clearTeamCircles', ()=>{
      [teamCircle, mateMarker, lockedMarker].forEach(el=> el.style.display='none');
      clearLayer(othersLayer);
      locked=false; 
      canClick=isMyTurn();
      btnLock.classList.remove('hidden');
      btnUnlock.classList.add('hidden');
      statusEl.textContent = canClick ? 'Klicke auf die gesuchte Stelle…' : 'Warten – anderes Team ist dran…';
      updateBoardInteractivity();
    });

    /* ---------- Reveal Zielbereich / Show Full ---------- */
    socket.on('round:revealArea', ({target, radius:rad, isNormalized})=>{
      const rect = boardRect();
      const tx = (isNormalized || roundIsNormalized) ? target.x * rect.width  : target.x;
      const ty = (isNormalized || roundIsNormalized) ? target.y * rect.height : target.y;
      maskEl.style.background = `radial-gradient(circle ${rad}px at ${tx}px ${ty}px,
        rgba(0,0,0,0) 0%, rgba(0,0,0,0) ${rad-1}px, rgba(0,0,0,1) ${rad}px)`;
      show(maskEl); // Außen bleibt schwarz, nur Ziel wird hell
    });

    socket.on('round:showFull', ()=>{
      hide(maskEl);
      statusEl.textContent = 'Gesamtes Bild sichtbar';
      canClick = false;
      updateBoardInteractivity();
      // othersLayer kann bleiben – ist oft nützlich zum Nachsehen
    });

    /* ---------- Upload kleiner Helfer ---------- */
    socket.on('toast', showToast);
  </script>
</body>
</html>

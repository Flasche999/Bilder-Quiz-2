<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Spieler Â· Bilderâ€‘RÃ¤tsel Quiz</title>
  <link rel="stylesheet" href="/style.css"/>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Spieler Â· Bilderâ€‘RÃ¤tsel Quiz</h1>

    <div id="joinCard" class="card">
    <div id="liveLobby" class="card" style="display:block">
      <h3>Teams & Spieler (Lobby)</h3>
      <div id="teamGrid"></div>
    </div>

      <div class="row">
        <div class="col">
          <label>Dein Spielername</label>
          <input id="playerName" placeholder="z.â€¯B. Dennis"/>
        </div>
        <div class="col">
          <label>Team wÃ¤hlen oder neu eingeben (2â€“4 Teams gesamt)</label>
          <input id="teamName" placeholder="Teamname"/>
        </div>
        <div class="col" style="align-self:flex-end">
          <button id="btnJoin" class="btn acc">Beitreten</button>
        </div>
      </div>
      <div class="small">Hinweis: Dein Teamâ€‘Partner sieht live deinen Klickâ€‘Marker â€“ andere Teams nicht.</div>
    </div>

    <div id="gameCard" class="card" style="display:none">
      <div class="row" style="align-items:center;justify-content:space-between">
        <div class="tag">Frage: <span id="question">â€“</span></div>
        <div class="tag">Team: <span id="myTeamName"></span></div>
        <div class="tag">Countdown: <span id="countdown">â€“</span></div>
        <div class="tag">Status: <span id="status">Wartenâ€¦</span></div>
      </div>
      <div class="hr"></div>
      <div class="center">
        <div id="board" class="board">
          <img id="img" src="" alt=""/>
          <div id="mask" class="mask" style="display:none"></div>
          <div id="myMarker" class="marker" style="display:none"></div>
          <div id="mateMarker" class="marker team" style="display:none"></div>
          <div id="lockedMarker" class="marker locked" style="display:none"></div>
        </div>
      </div>
      
      <div class="hr"></div>
      <div>
        <h3>Teams & Punkte</h3>
        <div id="sidebarTeams"></div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnLock" class="btn good">âœ… Fertig (einloggen)</button>
        <button id="btnUnlock" class="btn warn" style="display:none">ğŸ”“ Ã„nderung</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

  <script>
    const socket = io();
const COLORS = ['#4da3ff','#ff4d6d','#22c55e','#eab308'];
window.__stateTeams = {}; window.__statePlayers = {};
    const joinCard = document.getElementById('joinCard');
    const gameCard = document.getElementById('gameCard');
    const playerNameInput = document.getElementById('playerName');
    const teamNameInput = document.getElementById('teamName');
    const btnJoin = document.getElementById('btnJoin');
    const myTeamNameEl = document.getElementById('myTeamName');
    const countdownEl = document.getElementById('countdown');
    const statusEl = document.getElementById('status');
    const imgEl = document.getElementById('img');
    const boardEl = document.getElementById('board');
    const maskEl = document.getElementById('mask');
    const myMarker = document.getElementById('myMarker');
    const mateMarker = document.getElementById('mateMarker');
    const lockedMarker = document.getElementById('lockedMarker');
    const btnLock = document.getElementById('btnLock');
    const btnUnlock = document.getElementById('btnUnlock');
    const toast = document.getElementById('toast');

    let my = {id:null, name:'', teamId:null};
    let canClick = false;
    let radius = 45;
    let locked = false;
    let imageRect = null;

    function showToast(msg){
      toast.textContent = msg;
      toast.style.display = 'block';
      setTimeout(()=> toast.style.display='none', 2500);
    }

    function boardRect(){
      const r = boardEl.getBoundingClientRect();
      return {left:r.left + window.scrollX, top:r.top + window.scrollY, width:r.width, height:r.height};
    }
    function px(v){ return v+'px'; }
    
    function teamColor(t){
      const idx = (t && typeof t.colorIdx==='number') ? t.colorIdx : 0;
      return COLORS[idx % COLORS.length];
    }

    function renderLobbyTeams(){
      const grid = document.getElementById('teamGrid');
      const teams = window.__stateTeams || {};
      const players = window.__statePlayers || {};
      const grouped = {};
      Object.values(players).forEach(p=>{
        grouped[p.teamId] = grouped[p.teamId] || [];
        grouped[p.teamId].push(p);
      });
      const cards = Object.values(teams).map(t=>{
        const list = grouped[t.id] || [];
        const full = list.length >= 2;
        const color = teamColor(t);
        const btn = full ? `<button class="btn" disabled>Team voll</button>` : `<button class="btn acc" data-join="${t.id}">Team beitreten</button>`;
        return `<div class="card" style="border-left:6px solid ${color}; margin:6px 0">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
            <div>
              <div class="tag" style="border-color:${color}">ğŸ·ï¸ ${t.name}</div>
              <div class="small">Punkte: <strong>${t.points||0}</strong> â€¢ Spieler (${list.length}/2): ${list.map(p=>p.name).join(', ')||'â€”'}</div>
            </div>
            ${btn}
          </div>
        </div>`;
      }).join('') || '<div class="small">Noch keine Teams â€“ gib oben einen Teamnamen ein, um das erste zu erstellen.</div>';
      grid.innerHTML = cards;
      grid.querySelectorAll('button[data-join]').forEach(b=>{
        b.onclick = ()=>{
          const teamId = b.getAttribute('data-join');
          // Fill teamName input with selected team; keep player name as typed
          const t = teams[teamId];
          if(t){ teamNameInput.value = t.name; }
        };
      });
    }

    function renderSidebar(){
      const el = document.getElementById('sidebarTeams');
      const teams = Object.values(window.__stateTeams||{});
      const players = window.__statePlayers || {};
      const grouped = {};
      Object.values(players).forEach(p=>{
        grouped[p.teamId] = grouped[p.teamId] || [];
        grouped[p.teamId].push(p);
      });
      el.innerHTML = teams.map(t=>{
        const color = teamColor(t);
        const list = grouped[t.id] || [];
        return `<div class="tag" style="display:block;margin:4px 0;border-color:${color}">
          â­ ${t.points||0} â€” ${t.name} <span class="small">(${list.map(p=>p.name).join(', ')||'â€”'})</span>
        </div>`;
      }).join('');
    }

    function placeMarkerAt(el, x, y, r){
      el.style.left = px(x);
      el.style.top = px(y);
      el.style.width = px(r*2);
      el.style.height = px(r*2);
      el.style.display = 'block';
    }

    btnJoin.onclick = ()=>{
      const name = (playerNameInput.value||'').trim();
      const teamName = (teamNameInput.value||'').trim();
      if(!name || !teamName){ showToast('Bitte Name und Team ausfÃ¼llen.'); return; }
      socket.emit('player:join', {name, teamName});
    };

    socket.on('player:accepted', (p)=>{
      my = p;
      myTeamNameEl.textContent = p.teamName;
      joinCard.style.display='none';
      gameCard.style.display='block';
    });

    socket.on('state', s=>{ window.__stateTeams = s.teams||{}; window.__statePlayers = s.players||{}; renderLobbyTeams(); renderSidebar(); });

    // Round flow
    socket.on('round:config', (cfg)=>{
      // Reset state
      locked=false; canClick=false;
      myMarker.style.display='none';
      mateMarker.style.display='none';
      lockedMarker.style.display='none';
      maskEl.style.display='none';
      statusEl.textContent = 'Countdown lÃ¤uftâ€¦';

      imgEl.src = cfg.imageUrl;
      radius = cfg.radius;
      countdownEl.textContent = cfg.duration;
    });

    socket.on('round:tick', (t)=>{
      countdownEl.textContent = t;
    });

    socket.on('round:dark', ()=>{
      maskEl.style.display='block';
      canClick=true;
      statusEl.textContent = 'Klicke auf die gesuchte Stelleâ€¦';
    });

    boardEl.addEventListener('click', (e)=>{
      if(!canClick || locked) return;
      const r = boardRect();
      const x = e.pageX - r.left;
      const y = e.pageY - r.top;
      placeMarkerAt(myMarker, x, y, radius);
      socket.emit('player:clickUpdate', {x, y});
    });

    btnLock.onclick = ()=>{
      if(myMarker.style.display==='none'){ showToast('Bitte zuerst klicken.'); return; }
      locked = true; canClick=false;
      btnLock.style.display='none';
      btnUnlock.style.display='inline-block';
      lockedMarker.style.left = myMarker.style.left;
      lockedMarker.style.top = myMarker.style.top;
      lockedMarker.style.width = myMarker.style.width;
      lockedMarker.style.height = myMarker.style.height;
      lockedMarker.style.display = 'block';
      socket.emit('player:lock');
      statusEl.textContent = 'Eingeloggt â€“ warte auf AuflÃ¶sungâ€¦';
    };
    btnUnlock.onclick = ()=>{
      locked = false; canClick=true;
      btnLock.style.display='inline-block';
      btnUnlock.style.display='none';
      lockedMarker.style.display='none';
      socket.emit('player:unlock');
      statusEl.textContent = 'Ã„nderung mÃ¶glich â€“ erneut klicken und einloggen.';
    };

    // Teammate live marker (hidden from other teams)
    socket.on('team:mateClick', ({x,y})=>{
      if(!canClick) return;
      placeMarkerAt(mateMarker, x, y, radius);
    });

    // After admin reveals, show all teams
    socket.on('round:revealGuesses', (teamMarkers)=>{
      // For simplicity, show teammate marker as-is; other teams are not drawn on player view
      statusEl.textContent = 'Klicks sichtbar (Teamâ€‘weise)';
    });

    // Reveal target area (unmask circle at target)
    socket.on('round:revealArea', ({target, radius})=>{
      // Create a circular clip by hiding part of the mask via CSS radial-gradient
      maskEl.style.background = `radial-gradient(circle ${radius}px at ${target.x}px ${target.y}px, rgba(0,0,0,0) 0%, rgba(0,0,0,0) ${radius-1}px, rgba(0,0,0,.88) ${radius}px)`;
    });

    // Show full image again
    socket.on('round:showFull', ()=>{
      maskEl.style.display='none';
      statusEl.textContent = 'Gesamtes Bild sichtbar';
    });

    // Utility updates
    socket.on('toast', showToast);
  </script>
</body>
</html>
